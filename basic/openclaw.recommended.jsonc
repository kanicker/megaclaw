// OpenClaw Cognitive Upgrade Kit — Recommended Configuration
// Copy the relevant sections into your ~/.openclaw/openclaw.json
// Then run: openclaw gateway restart
//
// This config addresses the three most common problems:
// 1. Memory loss during compaction (memoryFlush + reserveTokensFloor)
// 2. Memory not searchable across sessions (memorySearch)
// 3. Group/channel sessions running with too much access (sandbox)
//
// You do NOT need all of these. Pick what applies to you.

{
  agents: {
    defaults: {

      // ── Compaction & Memory Flush ──────────────────────────────
      // This is the most important section. Without memoryFlush,
      // the agent loses context silently when sessions get long.
      //
      // Two tiers — pick the one that matches your usage:
      //
      //   STANDARD (most users):
      //     reserveTokensFloor: 20000   (OpenClaw default)
      //     softThresholdTokens: 4000
      //     Usable context on 200k window: ~176k tokens
      //     Good for: chat, light tool use, short-to-medium sessions
      //
      //   HEAVY TOOLS (recommended if you hit compaction often):
      //     reserveTokensFloor: 40000
      //     softThresholdTokens: 8000
      //     Usable context on 200k window: ~152k tokens
      //     Good for: long coding sessions, heavy exec/browser output,
      //     multi-file edits, sessions that regularly exceed 1 hour
      //
      // If unsure, start with Standard. If you see compaction events
      // in `python3 TOOLS/openclaw_compaction_diagnostics.py summary`,
      // switch to Heavy Tools.
      compaction: {
        mode: "default",

        // ── Standard tier (default) ──
        reserveTokensFloor: 20000,

        // ── Heavy Tools tier (uncomment this, comment out Standard) ──
        // reserveTokensFloor: 40000,

        // Pre-compaction memory flush: the agent saves durable context
        // to memory files BEFORE compaction summarizes the conversation.
        // This is the #1 fix for "my agent forgot what it was doing."
        memoryFlush: {
          enabled: true,
          softThresholdTokens: 4000,   // Standard. Use 8000 for Heavy Tools tier.

          // Kit-aware flush prompts — the agent saves decisions and
          // working state to GLOBAL-STATE.yaml and daily memory,
          // not just raw notes.
          systemPrompt: "Session nearing compaction. Save durable context now: ACTIVE decisions to GLOBAL-STATE.yaml, working state to memory/YYYY-MM-DD.md. Preserve prediction ids and conflict status.",
          prompt: "Write any ACTIVE decisions, open predictions, unresolved conflicts, and working context to memory/YYYY-MM-DD.md and update GLOBAL-STATE.yaml. Reply with NO_REPLY if nothing to store.",
        },
      },

      // ── Memory Search ─────────────────────────────────────────
      // Enables semantic search across MEMORY.md and memory/*.md.
      // Without this, the agent can only find memories by reading
      // files directly — which fails when there are many daily logs.
      memorySearch: {
        // Pick one: "openai", "gemini", "voyage", "local"
        // "local" requires no API key but needs pnpm approve-builds.
        // "openai" or "gemini" uses your existing API key.
        // provider: "openai",

        // Enable file watching so new memories are indexed automatically.
        sync: { watch: true },

        // Enable embedding cache to avoid re-embedding unchanged chunks.
        cache: { enabled: true },
      },

      // ── Sandbox (non-main sessions) ───────────────────────────
      // Group chats and channel sessions run in Docker sandboxes.
      // Main session (your private DM) runs on the host as usual.
      // This prevents prompt injection from group messages from
      // accessing your filesystem or running dangerous commands.
      sandbox: {
        mode: "non-main",
      },

      // ── Context Pruning (optional) ────────────────────────────
      // Aggressively prunes old tool outputs to keep context lean.
      // Useful if your agent runs many exec/browser commands.
      // contextPruning: {
      //   mode: "cache-ttl",
      //   ttl: "5m",
      //   softTrimRatio: 0.3,
      //   hardClearRatio: 0.5,
      // },

    },
  },

  // ── Gateway Security ────────────────────────────────────────
  // Bind to loopback only. Use Tailscale or SSH tunnel for remote.
  gateway: {
    bind: "loopback",
  },
}
